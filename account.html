<!DOCTYPE html>
<html>
<head>
<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
<meta content="utf-8" http-equiv="encoding">

<script type="text/javascript" src="DBController.js"></script>
<script type="text/javascript" src="Mail_Settings.js"></script>
<script type="text/javascript" src="Auto_Config_Get.js"></script>
<script type="text/javascript" src="Auto_Config_Interface.js"></script>
<script type="text/javascript" src="logger.js"></script>
<script type="text/javascript" src="TCP_Interface.js"></script>

<script type="text/javascript"  src="ui/jquery-2.1.1.js"></script>

</head>





<body>
  <button type="button" onclick="addDB();">Add Account</button>
  <button type="button" onclick="Check();">Check Config</button>
  <!-- <button type="button" onclick="viewDB();">View Account</button> -->  
  <br/>

	<div id="displaydiv">


	<table>
		<tr>
        	<td>Account</td>
            <td>
                <select id="accounts" onchange="setSetting()">
                  <option value="gmail">Gmail</option>
                  <option value="gmail">cse.mrt.ac.lk</option>
                  <option value="hotmail">Outlook</option>  
                  <option value="local">localhost</option>
                  <option value="uom.lk">uom.lk</option>
                  <option value="other" selected>other</option>
                </select>
           </td>
   	</tr>       
  </table>    
</div>
 
<div id="imapdiv">  
	<!-- <label>user</label> -->
    <table>
      <tr>
        <td>user:</td>
        <td><input type="text" id="user" value=""></td>
      </tr> 
      <tr>
        <td>pass:</td>
        <td><input type="text" id="pass" value=""></td>
      </tr>  
      <tr>
      	<td>smtp:</td>
        <td><input type="text" id="smtp" value=""></td>
      </tr>
      <tr>
      	<td>smtpport:</td>
      	<td><input type="text" id="smtpport" value=""></td>        
      	<td><select id="smtpsec" onchange="">
            <option value="ssl">SSL</option>
            <option value="tls">TLS</option>  
            <option value="no">NO</option>  
            </select>
    	 </td>
      </tr>          
      <tr> 
       <td>

        
       </td>       
      </tr>
      <tr>
      	<td>imap:</td>
        <td><input type="text" id="imap" value=""></td>
      </tr>
      <tr>
      	<td>imapport:</td>
      	<td><input type="text" id="imapport" value=""></td>        
      	<td><select id="imapsec" onchange="">
          	<option value="ssl">SSL</option>
          	<option value="tls">TLS</option>  
          	<option value="no">NO</option>  
        	</select>
    	  </td>        
        <!-- <td><input type="text" id="msgid" value=""></td> -->
      </tr>
           
    </table>                 
</div>

</br>
<select id="mail_accounts" onchange="showAccounts()"></select>
<button type="button" onclick="updateDB();">Update Account</button>

<div id="editAccount">  
  <!-- <label>user</label> -->
    <table>
      <tr>
        <td>user:</td>
        <td><input type="text" id="newuser" value=""></td>
      </tr> 
      <tr>
        <td>pass:</td>
        <td><input type="text" id="newpass" value=""></td>
      </tr>  
      <tr>
        <td>smtp:</td>
        <td><input type="text" id="newsmtp" value=""></td>
      </tr>
      <tr>
        <td>smtpport:</td>
        <td><input type="text" id="newsmtpport" value=""></td>        
        <td><select id="newsmtpsec" onchange="">
            <option value="ssl">SSL</option>
            <option value="tls">TLS</option>  
            <option value="no">NO</option>  
            </select>
       </td>
      </tr>          
      <tr> 
       <td>

        
       </td>       
      </tr>
      <tr>
        <td>imap:</td>
        <td><input type="text" id="newimap" value=""></td>
      </tr>
      <tr>
        <td>imapport:</td>
        <td><input type="text" id="newimapport" value=""></td>        
        <td><select id="newimapsec" onchange="">
            <option value="ssl">SSL</option>
            <option value="tls">TLS</option>  
            <option value="no">NO</option>  
          </select>
        </td>        
        <!-- <td><input type="text" id="msgid" value=""></td> -->
      </tr>
           
    </table>                 
</div>
<button type="button" onclick="location.href='./'">Back to Home</button>

</body>


<script>

//create_openDB();
var db=new DBController();
db.create_open_account_DB(load);

function load(){    
  db.getAccounts(show);
}

function show(msgs){
  var msg;
  for (var i = 0; msg=msgs[i],i < msgs.length; i++) {
    $("#mail_accounts").append('<option value="'+msg.id+'">'+msg.username+'</option>');
  };  
  showAccounts();
}

function addDB(){
  try{
      db.addAccount();
  }catch(e){
    console.log(e);
  }
  
}

function viewDB(){
  db.viewAccounts();  
}

function updateDB(){
  var x = document.getElementById("mail_accounts").value;

  var newData={};
  newData.username=document.getElementById('newuser').value;
  newData.password=document.getElementById('newpass').value;
  newData.smtphost=document.getElementById('newsmtp').value;
  newData.smtpport=document.getElementById('newsmtpport').value;
  newData.imaphost=document.getElementById('newimap').value;
  newData.imapport=document.getElementById('newimapport').value;  
  newData.imapsecurity=document.getElementById('newimapsec').value; 
  newData.smtpsecurity=document.getElementById('newsmtpsec').value;

  db.updateAccounts(parseInt(x),newData);

  
}

function showAccounts(){
  var x = document.getElementById("mail_accounts").value;
  try{
    var id=parseInt(x);
  }catch(e){
    console.log(e);
    return;
  }
  db.loadAccountById(id,showSetting);
}

function showSetting(acc){
  // console.log(acc);
  document.getElementById('newuser').value=acc.username;
  document.getElementById('newpass').value=acc.password;
  document.getElementById('newsmtp').value=acc.smtphost;
  document.getElementById('newsmtpport').value=acc.smtpport;
  document.getElementById('newimap').value=acc.imaphost;
  document.getElementById('newimapport').value=acc.imapport;  
  document.getElementById('newimapsec').value=acc.imapsecurity; 
  document.getElementById('newsmtpsec').value=acc.smtpsecurity;
}

 function setSetting(){
 	var x = document.getElementById("accounts").value;
 	if (x=='gmail') {
 		document.getElementById('user').value='';
		document.getElementById('pass').value='';
		document.getElementById('smtp').value='smtp.gmail.com';
		document.getElementById('smtpport').value='465';
		document.getElementById('imap').value='imap.gmail.com';
		document.getElementById('imapport').value='993';	
		document.getElementById('imapsec').value='ssl';	
		document.getElementById('smtpsec').value='ssl';	
 	}else if(x=='hotmail'){ 	
 		document.getElementById('user').value='';
		document.getElementById('pass').value='';
		document.getElementById('smtp').value='Smtp-mail.outlook.com';
		document.getElementById('smtpport').value='587';
		document.getElementById('imap').value='imap-mail.outlook.com';
		document.getElementById('imapport').value='993';		
    document.getElementById('imapsec').value='ssl'; 
    document.getElementById('smtpsec').value='tls';  	
 	}else if(x=='local'){ 	
 		document.getElementById('user').value='';
		document.getElementById('pass').value='';
		document.getElementById('smtp').value='localhost';
		document.getElementById('smtpport').value='25';
		document.getElementById('imap').value='localhost';
		document.getElementById('imapport').value='143';		 	
		document.getElementById('imapsec').value='no';	
		document.getElementById('smtpsec').value='no';	
 	}else if(x=='other'){ 	
 		document.getElementById('user').value='';
		document.getElementById('pass').value='';
		document.getElementById('smtp').value='';
		document.getElementById('smtpport').value='';
		document.getElementById('imap').value='';
		document.getElementById('imapport').value='';		 	
 	}else if(x=='uom.lk'){  
    document.getElementById('user').value='';
    document.getElementById('pass').value='';
    document.getElementById('smtp').value='submit.uom.lk';
    document.getElementById('smtpport').value='587';
    document.getElementById('imap').value='uom.lk';
    document.getElementById('imapport').value='143';     
    document.getElementById('imapsec').value='no';  
    document.getElementById('smtpsec').value='no';  
  } 
 } 

var database;
function create_openDB(indexedDBName){
  // console.log('create_openDB');
  
  window.indexedDB = window.indexedDB || window.mozIndexedDB || window.webkitIndexedDB || window.msIndexedDB;
  window.IDBTransaction = window.IDBTransaction || window.webkitIDBTransaction || window.msIDBTransaction;
  window.IDBKeyRange = window.IDBKeyRange || window.webkitIDBKeyRange || window.msIDBKeyRange;  
  var self=this;
  if (!window.indexedDB) {
      alert("Sorry!Your browser doesn't support IndexedDB");
  }

  // dbVersion++;
    var request = window.indexedDB.open('accounts');

    // console.log(request.result.version);

    request.onerror = function(event) {
      console.log(event.target.errorCode);
    };

    request.onblocked=function(event){
      console.log('open onblocked '+event);     
  }

    request.onsuccess = function(event) {
        database=request.result;        
        console.log('show content');
        
    };

    request.onupgradeneeded = function(event) {
        var db = event.target.result;
        var objectStore = db.createObjectStore('accounts', {keyPath: "id",autoIncrement:true});
        objectStore.createIndex("usernameIndex", "username", { multiEntry: true });
    };    

}

var imaps=0;
var domain="example.com";
function Check(){
  var config=new Auto_Config_Get(++imaps);

  var filter = /^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/;
  domain=document.getElementById('user').value;
  if (!filter.test(domain)) {
    alert('Please provide a valid email address');
  }else {
    domain = domain.replace(/.*@/, "");
    console.log('Searching config for domain: '+domain);
    config.getConfigs(function(result){
      if(!result){
        console.log('no config found, enter manually'); 
        return;
      }
      //console.log(result);
      document.getElementById('smtp').value=result.smtphost;
      document.getElementById('smtpport').value=result.smtpport;
      document.getElementById('smtpsec').value=(result.smtpsec=="STARTTLS" ? 'tls' : (result.smtpsec=="SSL" ? 'ssl' : 'no'));
      document.getElementById('imap').value=result.imaphost;
      document.getElementById('imapport').value=result.imapport;
      document.getElementById('imapsec').value=(result.imapsec=="SSL" ? 'ssl' : 'no');
      console.log('Auto_Config_Get finish');
    });
  }
}

</script>
</html>
